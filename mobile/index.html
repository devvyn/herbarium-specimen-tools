<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">

    <title>Herbarium Review</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/app.css">

    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
    <div id="app">
        <!-- Loading State -->
        <div v-if="loading" class="loading-screen">
            <div class="spinner"></div>
            <p>Loading specimens...</p>
        </div>

        <!-- Login Screen -->
        <div v-else-if="!isAuthenticated" class="login-screen">
            <div class="login-card">
                <h1>üåø Herbarium Review</h1>
                <p>Mobile specimen curation</p>

                <form @submit.prevent="login" class="login-form">
                    <label for="login-username" class="sr-only">Username</label>
                    <input
                        id="login-username"
                        v-model="username"
                        type="text"
                        placeholder="Your name"
                        class="input"
                        autocapitalize="none"
                    >
                    <button type="submit" class="btn btn-primary">
                        Start Reviewing
                    </button>
                </form>

                <div v-if="loginError" class="error-message">
                    {{ loginError }}
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div v-else class="app-container">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <h1 class="header-title">
                        <span v-if="currentView === 'queue'">Review Queue</span>
                        <span v-else-if="currentView === 'specimen'">Specimen Details</span>
                        <span v-else>Statistics</span>
                    </h1>
                    <div class="header-actions">
                        <button
                            v-if="currentView !== 'queue'"
                            @click="currentView = 'queue'"
                            class="btn-icon"
                            aria-label="Back to queue"
                        >
                            ‚Üê Back
                        </button>
                        <button @click="showStats = !showStats" class="btn-icon" aria-label="Toggle statistics">
                            üìä
                        </button>
                    </div>
                </div>

                <!-- Stats Banner -->
                <div v-if="showStats" class="stats-banner">
                    <div class="stat">
                        <span class="stat-label">Total</span>
                        <span class="stat-value">{{ stats.total_specimens || 0 }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Pending</span>
                        <span class="stat-value">{{ stats.status_counts?.PENDING || 0 }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Approved</span>
                        <span class="stat-value">{{ stats.status_counts?.APPROVED || 0 }}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Critical</span>
                        <span class="stat-value critical">{{ stats.priority_counts?.CRITICAL || 0 }}</span>
                    </div>
                    <div class="stat" v-if="stats.correction_stats">
                        <span class="stat-label">Corrections</span>
                        <span class="stat-value">{{ stats.correction_stats?.total_field_corrections || 0 }}</span>
                    </div>
                </div>
            </header>

            <!-- Offline Status Banner -->
            <div v-if="!isOnline" class="offline-banner">
                <span>üì° Offline Mode</span>
                <span class="offline-hint">Changes will sync when connection is restored</span>
            </div>

            <!-- Queue View -->
            <div v-if="currentView === 'queue'" class="queue-view">
                <!-- Filters -->
                <div class="filters">
                    <select v-model="filters.priority" @change="loadQueue" class="filter-select">
                        <option value="">All Priorities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                    </select>

                    <select v-model="filters.status" @change="loadQueue" class="filter-select">
                        <option value="">All Status</option>
                        <option value="PENDING">Pending</option>
                        <option value="IN_REVIEW">In Review</option>
                        <option value="APPROVED">Approved</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>

                <!-- Specimen Cards -->
                <div class="specimen-cards">
                    <div
                        v-for="specimen in queue"
                        :key="specimen.id"
                        @click="openSpecimen(specimen.id)"
                        class="specimen-card"
                        :class="getPriorityClass(specimen.priority)"
                    >
                        <div class="card-header">
                            <span class="catalog-number">{{ specimen.catalog_number || 'No #' }}</span>
                            <span class="priority-badge" :class="specimen.priority.toLowerCase()">
                                {{ specimen.priority }}
                            </span>
                        </div>

                        <div class="card-body">
                            <p class="scientific-name">{{ specimen.scientific_name }}</p>
                            <div class="card-metrics">
                                <span class="metric">
                                    Quality: {{ specimen.quality_score }}%
                                </span>
                                <span class="metric">
                                    Complete: {{ specimen.completeness }}%
                                </span>
                            </div>
                        </div>

                        <div class="card-footer">
                            <span class="status-badge" :class="specimen.status.toLowerCase()">
                                {{ specimen.status }}
                            </span>
                            <span v-if="specimen.flagged" class="flag-icon">üö©</span>
                            <span v-if="specimen.critical_issues > 0" class="issue-count">
                                ‚ö†Ô∏è {{ specimen.critical_issues }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Load More -->
                <div v-if="hasMore" class="load-more">
                    <button @click="loadMore" class="btn btn-secondary">
                        Load More
                    </button>
                </div>
            </div>

            <!-- Specimen Detail View -->
            <div v-else-if="currentView === 'specimen'" class="specimen-view">
                <div v-if="currentSpecimen" class="specimen-detail">
                    <!-- Image Viewer -->
                    <div class="image-container" :class="{ loading: !imageLoaded, loaded: imageLoaded }" ref="imageContainer">
                        <img
                            :src="getImageUrl(currentSpecimen.id)"
                            :alt="currentSpecimen.id"
                            class="specimen-image"
                            @load="onImageLoad"
                            ref="specimenImage"
                        >

                        <!-- OCR Controls -->
                        <div v-if="hasOcrRegions" class="ocr-controls">
                            <!-- Toggle OCR Button -->
                            <button
                                @click.stop="toggleOcrOverlay"
                                class="ocr-toggle"
                                :class="{ active: showOcrRegions }"
                                :aria-pressed="showOcrRegions"
                                aria-label="Toggle OCR region overlay"
                            >
                                <span class="ocr-toggle-icon">{{ showOcrRegions ? 'üëÅ' : 'üëÅ‚Äçüó®' }}</span>
                                <span>{{ showOcrRegions ? 'Hide' : 'Show' }} OCR</span>
                            </button>

                            <!-- Select Regions Button -->
                            <button
                                v-if="showOcrRegions && !regionSelectionMode"
                                @click.stop="toggleRegionSelectionMode"
                                class="ocr-toggle"
                                aria-label="Select regions for re-extraction"
                            >
                                <span class="ocr-toggle-icon">‚úì</span>
                                <span>Select</span>
                            </button>

                            <!-- Selection Mode Controls -->
                            <template v-if="regionSelectionMode">
                                <button
                                    @click.stop="submitRegionReextraction"
                                    class="ocr-toggle active"
                                    :disabled="!hasSelectedRegions || actionLoading"
                                    aria-label="Submit selected regions for re-extraction"
                                >
                                    <span class="ocr-toggle-icon">üîÑ</span>
                                    <span>Re-extract ({{ selectedRegionIndices.length }})</span>
                                </button>
                                <button
                                    @click.stop="toggleRegionSelectionMode"
                                    class="ocr-toggle"
                                    aria-label="Cancel region selection"
                                >
                                    <span class="ocr-toggle-icon">‚úï</span>
                                    <span>Cancel</span>
                                </button>
                            </template>

                            <!-- Pending Re-extraction Badge -->
                            <span
                                v-if="hasPendingReextractionRegions && !regionSelectionMode"
                                class="pending-badge"
                                @click.stop="clearPendingReextractions"
                                title="Click to clear pending re-extractions"
                            >
                                üîÑ {{ pendingReextractionCount }} pending
                            </span>
                        </div>

                        <!-- OCR Regions SVG Overlay -->
                        <svg
                            v-if="showOcrRegions && hasOcrRegions && imageLoaded"
                            class="ocr-overlay"
                            :class="{ 'selection-mode': regionSelectionMode }"
                            ref="ocrOverlay"
                            preserveAspectRatio="xMinYMin meet"
                            role="group"
                            :aria-label="'OCR regions overlay with ' + currentSpecimen.ocr_regions.length + ' detected text regions. ' + (regionSelectionMode ? 'Selection mode active. Press Space or Enter to select regions.' : 'Press Tab to navigate between regions.')"
                        >
                            <rect
                                v-for="(region, index) in currentSpecimen.ocr_regions"
                                :key="index"
                                :x="region.bounds.x * imageWidth"
                                :y="(1 - region.bounds.y - region.bounds.height) * imageHeight"
                                :width="region.bounds.width * imageWidth"
                                :height="region.bounds.height * imageHeight"
                                class="ocr-region"
                                :class="[
                                    'confidence-' + getConfidenceClass(region.confidence),
                                    {
                                        highlighted: highlightedRegionIndex === index,
                                        selected: isRegionSelected(index),
                                        'pending-reextraction': isRegionPendingReextraction(index)
                                    }
                                ]"
                                role="button"
                                tabindex="0"
                                :aria-label="'OCR region: ' + region.text.substring(0, 50) + (region.text.length > 50 ? '...' : '') + ' (' + Math.round(region.confidence * 100) + '% confidence)'"
                                @click.stop="regionSelectionMode ? toggleRegionSelection(index) : showRegionTooltip(region, $event)"
                                @keydown.enter.stop="regionSelectionMode ? toggleRegionSelection(index) : showRegionTooltip(region, $event)"
                                @keydown.space.prevent.stop="regionSelectionMode ? toggleRegionSelection(index) : showRegionTooltip(region, $event)"
                                @mouseenter="hoverRegion = region"
                                @mouseleave="hoverRegion = null"
                                @focus="hoverRegion = region"
                                @blur="hoverRegion = null"
                            />
                        </svg>

                        <!-- OCR Region Tooltip (hover) -->
                        <div
                            v-if="hoverRegion && showOcrRegions && !showRegionMenu"
                            class="ocr-tooltip"
                            :style="tooltipStyle"
                        >
                            <div><strong>{{ hoverRegion.text }}</strong></div>
                            <div>Confidence: {{ Math.round(hoverRegion.confidence * 100) }}%</div>
                            <div v-if="hoverRegion.zone">Zone: {{ hoverRegion.zone.vertical }}-{{ hoverRegion.zone.horizontal }}</div>
                        </div>

                        <!-- OCR Region Action Menu (click) -->
                        <div
                            v-if="showRegionMenu && selectedRegion"
                            class="ocr-action-menu"
                            :style="{ left: regionMenuX + 'px', top: regionMenuY + 'px' }"
                            @click.stop
                        >
                            <div class="ocr-menu-header">
                                <span class="ocr-menu-text">{{ selectedRegion.text.substring(0, 40) }}{{ selectedRegion.text.length > 40 ? '...' : '' }}</span>
                                <button class="ocr-menu-close" @click="closeRegionMenu" aria-label="Close menu">&times;</button>
                            </div>
                            <div class="ocr-menu-confidence">
                                {{ Math.round(selectedRegion.confidence * 100) }}% confidence
                            </div>
                            <div class="ocr-menu-actions">
                                <button @click="copyRegionText" class="ocr-menu-btn">
                                    üìã Copy text
                                </button>
                                <button @click="markRegionForReextraction" class="ocr-menu-btn">
                                    üîÑ Mark for re-extraction
                                </button>
                                <div class="ocr-menu-divider"></div>
                                <div class="ocr-menu-label">Use as field value:</div>
                                <div class="ocr-menu-fields">
                                    <button
                                        v-for="(field, fieldName) in suggestedFieldsForRegion"
                                        :key="fieldName"
                                        @click="useRegionAsFieldValue(fieldName)"
                                        class="ocr-menu-field-btn"
                                    >
                                        {{ fieldName }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Click outside to close menu -->
                        <div
                            v-if="showRegionMenu"
                            class="ocr-menu-backdrop"
                            @click="closeRegionMenu"
                        ></div>

                        <div class="image-hint">Pinch to zoom</div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <button
                            @click="quickAction('approve')"
                            class="btn btn-success"
                            :disabled="actionLoading"
                            aria-label="Approve: Data is correct, ready for export"
                            title="Data is correct, include in DwC export"
                        >
                            ‚úì Approve
                        </button>
                        <button
                            @click="quickAction('reextract')"
                            class="btn btn-warning"
                            :disabled="actionLoading"
                            aria-label="Re-extract: Image OK but extraction failed"
                            title="Image is fine, but extraction needs to be re-run"
                        >
                            üîÑ Re-extract
                        </button>
                        <button
                            @click="quickAction('flag')"
                            class="btn btn-secondary"
                            :disabled="actionLoading"
                            aria-label="Flag: Need expert review"
                            title="Uncertain, need expert to review"
                        >
                            üö© Flag
                        </button>
                        <button
                            @click="quickAction('reject')"
                            class="btn btn-danger"
                            :disabled="actionLoading"
                            aria-label="Reject: Unusable, exclude from export"
                            title="Data is unusable, exclude from DwC export"
                        >
                            ‚úó Reject
                        </button>
                    </div>

                    <!-- Action Guide -->
                    <div class="action-guide">
                        <details>
                            <summary>Action guide</summary>
                            <ul>
                                <li><strong>Approve</strong>: Data correct ‚Üí include in export</li>
                                <li><strong>Re-extract</strong>: Image OK, extraction failed ‚Üí re-process</li>
                                <li><strong>Flag</strong>: Uncertain ‚Üí expert review needed</li>
                                <li><strong>Reject</strong>: Unusable ‚Üí exclude from export</li>
                            </ul>
                        </details>
                    </div>

                    <!-- Priority Control -->
                    <div class="priority-control">
                        <label for="priority-select">Priority</label>
                        <select
                            id="priority-select"
                            v-model="currentSpecimen.review.priority"
                            @change="updatePriority"
                            class="filter-select"
                        >
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                            <option value="MINIMAL">Minimal</option>
                        </select>
                    </div>

                    <!-- Provenance Summary -->
                    <div v-if="currentSpecimen.provenance" class="provenance-summary">
                        <h3>Extraction Info</h3>
                        <div class="provenance-grid">
                            <div class="provenance-item">
                                <span class="provenance-label">Model</span>
                                <span class="provenance-value">{{ formatModelName(currentSpecimen.provenance.model) }}</span>
                            </div>
                            <div class="provenance-item">
                                <span class="provenance-label">Provider</span>
                                <span class="provenance-value">{{ currentSpecimen.provenance.provider || 'Unknown' }}</span>
                            </div>
                            <div v-if="currentSpecimen.provenance.timestamp" class="provenance-item">
                                <span class="provenance-label">Extracted</span>
                                <span class="provenance-value">{{ formatDate(currentSpecimen.provenance.timestamp) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Field Editor -->
                    <div class="fields-editor">
                        <h3>Fields</h3>

                        <div
                            v-for="(fieldData, fieldName) in currentSpecimen.fields"
                            :key="fieldName"
                            class="field-item"
                            :class="{
                                'low-confidence': fieldData.confidence < 0.7,
                                'ocr-linkable': showOcrRegions && hasOcrRegions
                            }"
                            @click="highlightMatchingRegions(fieldData.value)"
                        >
                            <div class="field-header">
                                <label class="field-label">{{ formatFieldName(fieldName) }}</label>
                                <div class="field-badges">
                                    <span
                                        v-if="fieldData.human_reviewed"
                                        class="reviewed-badge"
                                        title="Human reviewed"
                                    >‚úì</span>
                                    <span
                                        class="confidence-badge"
                                        :class="getConfidenceClass(fieldData.confidence)"
                                    >
                                        {{ Math.round(fieldData.confidence * 100) }}%
                                    </span>
                                </div>
                            </div>

                            <div class="field-input-group">
                                <input
                                    v-model="fieldData.corrected_value"
                                    :placeholder="fieldData.value || 'No value'"
                                    class="input"
                                    @blur="saveFieldCorrection(fieldName, fieldData)"
                                >
                                <button
                                    v-if="fieldData.value && !fieldData.corrected_value"
                                    @click="acceptSuggestion(fieldName, fieldData)"
                                    class="btn-sm btn-accept"
                                    title="Accept AI suggestion"
                                >
                                    ‚úì
                                </button>
                            </div>

                            <div v-if="fieldData.value" class="field-hint">
                                AI suggested: {{ fieldData.value }}
                            </div>

                            <!-- Zone hint for low-confidence fields -->
                            <div v-if="fieldData.confidence < 0.7 && fieldData.zone_hint" class="zone-hint">
                                <span class="zone-icon">üìç</span>
                                <span>Look in: {{ fieldData.zone_hint.description }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- GBIF Validation -->
                    <div v-if="currentSpecimen.gbif_validation" class="gbif-validation">
                        <h3>GBIF Validation</h3>
                        <div class="validation-item">
                            <span>Taxonomy:</span>
                            <span :class="currentSpecimen.gbif_validation.taxonomy_verified ? 'success' : 'error'">
                                {{ currentSpecimen.gbif_validation.taxonomy_verified ? '‚úì Verified' : '‚úó Issues' }}
                            </span>
                        </div>
                        <div v-if="currentSpecimen.gbif_validation.taxonomy_issues?.length" class="issues-list">
                            <p v-for="issue in currentSpecimen.gbif_validation.taxonomy_issues" :key="issue">
                                ‚Ä¢ {{ issue }}
                            </p>
                        </div>
                    </div>

                    <!-- Review Feedback (workflow only, not exported) -->
                    <div class="notes-section">
                        <h3>Review Feedback</h3>
                        <p class="notes-hint">Workflow notes for re-extraction or expert review. Not included in DwC export.</p>
                        <textarea
                            v-model="currentSpecimen.review.review_notes"
                            placeholder="Instructions for re-extraction, questions for expert..."
                            class="textarea"
                            @blur="saveReviewNotes"
                        ></textarea>
                    </div>

                    <!-- DwC Notes (included in export) -->
                    <div class="notes-section">
                        <h3>DwC Notes</h3>
                        <p class="notes-hint">Canonical notes included in Darwin Core export (occurrenceRemarks).</p>
                        <textarea
                            v-model="currentSpecimen.review.notes"
                            placeholder="Notes to include in exported data..."
                            class="textarea"
                            @blur="saveNotes"
                        ></textarea>
                    </div>

                    <!-- Issues -->
                    <div v-if="currentSpecimen.issues?.critical?.length" class="issues-section">
                        <h3>Critical Issues</h3>
                        <div class="issue-item" v-for="issue in currentSpecimen.issues.critical" :key="issue">
                            ‚ö†Ô∏è {{ issue }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div v-if="toast.show" class="toast" :class="toast.type">
            <span>{{ toast.message }}</span>
            <button @click="dismissToast" class="toast-dismiss" aria-label="Dismiss notification">
                ‚úï
            </button>
        </div>
    </div>

    <!-- Scripts (versioned to bust cache) -->
    <script src="/js/error-tracker.js?v=1"></script>
    <script src="/js/api.js?v=5"></script>
    <script src="/js/app.js?v=5"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.error('Service Worker registration failed', err));
        }
    </script>
</body>
</html>
